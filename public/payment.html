<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pembayaran Transaksi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --bg-dark-start: #0f172a; /* Slate 900 */
            --bg-dark-end: #020617; /* Slate 950 */
            --card-bg-light: rgba(30, 41, 59, 0.4); /* Slate 800 with transparency */
            --card-bg-dark: rgba(15, 23, 42, 0.4); /* Slate 900 with transparency */
            --primary-accent: #6366f1; /* Indigo 500 */
            --primary-accent-dark: #4f46e5; /* Indigo 600 */
            --secondary-accent: #06b6d4; /* Cyan 500 */
            --text-light: #e2e8f0; /* Slate 200 */
            --text-medium: #94a3b8; /* Slate 400 */
            --text-dark: #64748b; /* Slate 500 */
            --success-color: #22c55e; /* Green 500 */
            --warning-color: #f59e0b; /* Amber 500 */
            --danger-color: #ef4444; /* Red 500 */
            --info-color: #3b82f6; /* Blue 500 */
        }
        body {
            background: linear-gradient(145deg, var(--bg-dark-start) 0%, var(--bg-dark-end) 100%);
            font-family: 'Inter', sans-serif;
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Consistent padding */
        }
        .container-wrapper {
            background: rgba(15, 23, 42, 0.6); /* Slightly more opaque for main container */
            backdrop-filter: blur(12px) brightness(1.1); /* Stronger blur for modern look */
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), 0 0 40px rgba(99, 102, 241, 0.2); /* Enhanced shadow with accent glow */
            border: 1px solid rgba(99, 102, 241, 0.3); /* Subtle accent border */
            padding: 2.5rem; /* More padding */
            animation-delay: 0.2s; /* Delay fade-in slightly */
        }
        /* Custom truncate style */
        .truncate-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        /* Loading overlay style */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px); /* Stronger blur for loading */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--primary-accent);
            font-family: 'Orbitron', sans-serif; /* Techy font for loading */
            flex-direction: column; /* For text and spinner */
            gap: 1rem;
        }
        .loading-dots {
            font-size: 2.5rem;
            letter-spacing: 0.3rem;
            animation: pulse-dots 1.5s infinite;
        }
        @keyframes pulse-dots {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        /* Card Styling Enhancement */
        .info-card {
            background: var(--card-bg-light);
            backdrop-filter: blur(10px) brightness(1.05);
            border-radius: 1rem; /* Slightly more rounded */
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(var(--primary-accent), 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 25px rgba(6, 182, 212, 0.3); /* secondary-accent in hover */
        }
        .info-card h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--secondary-accent);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.3); /* primary-accent for border */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .info-label {
            color: var(--text-medium);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .info-value {
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-light);
        }
        /* Specific value styling */
        .info-value.product-price {
            font-size: 1.5rem; /* Larger for price */
            font-weight: 700;
            color: var(--success-color);
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.4);
        }
        .info-value.nominal-bayar {
            font-size: 1.1rem;
            font-weight: 600;
        }
        /* Status colors */
        .status-success { color: var(--success-color); }
        .status-failed { color: var(--danger-color); }
        .status-pending { color: var(--warning-color); }
        .status-paid { color: var(--primary-accent); }
        .status-unpaid { color: var(--text-dark); }
        /* Buttons */
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3), 0 0 15px rgba(99, 102, 241, 0.5);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none; /* Ensure no underline for links */
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 25px rgba(99, 102, 241, 0.7);
            filter: brightness(1.1);
        }
        .btn-secondary {
            background-color: transparent; /* Changed to transparent for a more subtle look */
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border: 1px solid var(--text-dark);
        }
        .btn-secondary:hover {
            background-color: rgba(51, 65, 85, 0.3); /* Slate 700 with transparency */
            border-color: var(--primary-accent);
            color: var(--primary-accent);
        }
        /* QR Code section */
        #payment-action img {
            max-width: 280px; /* Slightly larger QR */
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4), 0 0 20px rgba(6, 182, 212, 0.4);
            border: 2px solid var(--secondary-accent);
        }
        /* Countdown */
        #countdown {
            background: rgba(239, 68, 68, 0.15); /* Red 500 with transparency */
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: var(--danger-color);
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 2rem;
            animation: pulse-countdown 2s infinite;
        }
        @keyframes pulse-countdown {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }
        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .container-wrapper {
                padding: 1.5rem;
                border-radius: 1rem;
            }
            .container-wrapper h1 {
                font-size: 1.75rem;
            }
            .container-wrapper p {
                font-size: 0.9rem;
            }
            .info-card {
                padding: 1rem;
            }
            .info-card h3 {
                font-size: 0.8rem;
                margin-bottom: 0.75rem;
            }
            .info-label {
                font-size: 0.75rem;
            }
            .info-value {
                font-size: 0.85rem;
            }
            .info-value.product-price {
                font-size: 1.2rem;
            }
            .info-value.nominal-bayar {
                font-size: 1rem;
            }
            .btn-primary {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            #payment-action img {
                max-width: 200px; /* Smaller QR on mobile */
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <div class="max-w-3xl w-full container-wrapper animate__animated animate__fadeIn">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold font-['Orbitron'] text-primary-accent leading-tight">Pembayaran</h1>
                <p class="text-text-medium mt-1">Lengkapi pembayaran sebelum waktu habis</p>
            </div>
            <div class="bg-primary-accent-dark/20 p-4 rounded-xl">
                <i class="fas fa-credit-card text-secondary-accent text-3xl"></i>
            </div>
        </div>

        <div id="transaction-details" class="space-y-6">
            </div>

        <div id="payment-action" class="mt-10 text-center">
            </div>
        
        <div id="countdown" class="hidden text-center"></div>
    </div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <svg class="animate-spin h-16 w-16 text-primary-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div class="loading-dots">MEMUAT...</div>
        <p class="text-text-medium mt-2">Menunggu data transaksi...</p>
    </div>

    <script>
        // Ambil reff_id dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const reff_id = urlParams.get("reff_id");
        const transactionDetailsEl = document.getElementById("transaction-details");
        const paymentActionEl = document.getElementById("payment-action");
        const countdownEl = document.getElementById("countdown");
        const loadingOverlayEl = document.getElementById("loading-overlay");

        let countdownInterval; // Variable to hold the countdown interval

        // Fungsi untuk format tanggal
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const d = new Date(timestamp);
            // Pastikan timestamp valid
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleString("id-ID", { timeZone: "Asia/Jakarta" });
        }

        // Fungsi untuk menyalin teks ke clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const copyButton = document.querySelector(`button[onclick="copyToClipboard('${text}')"]`);
                if (copyButton) {
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-check-circle"></i> Disalin!';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 2000);
                }
            }).catch((err) => {
                console.error("Gagal menyalin teks:", err);
                alert("Gagal menyalin teks.");
            });
        }

        // Fungsi untuk menampilkan pesan error
        function displayError(message) {
            transactionDetailsEl.innerHTML = `
                <div class="info-card text-center bg-danger-color/10 border-danger-color/30 animate__animated animate__fadeIn">
                    <div class="flex flex-col items-center justify-center space-y-3 text-danger-color py-4">
                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                        <p class="font-bold text-xl">${message}</p>
                        <p class="text-text-medium text-sm">Mohon coba lagi nanti atau hubungi dukungan.</p>
                    </div>
                </div>`;
            paymentActionEl.innerHTML = ''; // Clear payment action on error
            countdownEl.classList.add('hidden'); // Hide countdown on error
        }

        // Fungsi untuk mengupdate detail transaksi di UI
        function updateTransactionDetails(data) {
            const userData = data.data_user || {};
            const depositData = data.data_deposit || {};
            const transactionStatus = data.status || 'unpaid';
            const fee = (depositData.nominal || 0) - (depositData.harga_asli || 0);

            const detailHtml = `
                <div class="info-card animate__animated animate__fadeInUp">
                    <h3><i class="fas fa-user"></i> Informasi Pembeli</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="info-label">Nama</p>
                            <p class="info-value">${userData.nama || '-'}</p>
                        </div>
                        <div>
                            <p class="info-label">Email</p>
                            <p class="info-value">${userData.email || '-'}</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="info-label">ID/UID</p>
                            <p class="info-value font-mono truncate-text" title="${userData.target || '-'}">${userData.target || '-'}</p>
                        </div>
                    </div>
                </div>
                <div class="info-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Detail Pembayaran</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="info-label">Harga Produk</p>
                            <p class="info-value product-price">Rp ${Number(userData.price || 0).toFixed(0).toLocaleString('id-ID')}</p>
                        </div>
                        <div>
                            <p class="info-label">Fee</p>
                            <p class="info-value">Rp ${Number(fee).toFixed(0).toLocaleString('id-ID')}</p>
                        </div>
                        <div>
                            <p class="info-label">Nominal Bayar</p>
                            <p class="info-value nominal-bayar">Rp ${Number(depositData.nominal || 0).toFixed(0).toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                </div>
                <div class="info-card flex flex-col md:flex-row justify-between items-center md:items-start gap-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                    <div>
                        <p class="info-label">Status Transaksi</p>
                        <p class="info-value text-xl font-semibold ${
                            transactionStatus === 'completed' ? 'status-success' :
                            transactionStatus === 'failed' || transactionStatus === 'canceled' ? 'status-failed' :
                            transactionStatus === 'pending' ? 'status-pending' :
                            transactionStatus === 'paid' ? 'status-paid' :
                            transactionStatus === 'unpaid' ? 'status-unpaid' :
                            'text-white'
                        }">${transactionStatus ? transactionStatus.charAt(0).toUpperCase() + transactionStatus.slice(1) : '-'}</p>
                    </div>
                    <div class="text-right md:text-left">
                        <p class="info-label">Reff ID</p>
                        <div class="flex items-center justify-end md:justify-start space-x-2">
                            <p id="reff-id" class="info-value font-mono truncate-text max-w-[150px] md:max-w-none" title="${data.reff_id || '-'}">${data.reff_id || '-'}</p>
                            <button onclick="copyToClipboard('${data.reff_id}')" class="btn-secondary">
                                <i class="fas fa-copy"></i> Salin
                            </button>
                        </div>
                    </div>
                </div>
                <div class="info-card grid grid-cols-1 md:grid-cols-2 gap-4 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                    <div>
                        <p class="info-label">Dibuat Pada</p>
                        <p class="info-value">${formatDate(data.createdAt)}</p>
                    </div>
                    <div>
                        <p class="info-label">Kadaluarsa Pada</p>
                        <p class="info-value">${depositData.expired_at ? formatDate(depositData.expired_at) : '-'}</p>
                    </div>
                </div>
            `;
            transactionDetailsEl.innerHTML = detailHtml;

            // Handle payment action display
            if (transactionStatus === 'pending' || transactionStatus === 'unpaid') {
                if (depositData.qr_image) {
                    paymentActionEl.innerHTML = `
                        <p class="mb-5 text-xl font-medium text-text-light animate__animated animate__fadeIn">Scan QR Code untuk membayar:</p>
                        <img src="${depositData.qr_image}" alt="QRIS" class="mx-auto mb-6 rounded-lg border-2 border-secondary-accent shadow-lg animate__animated animate__zoomIn" style="max-width: 280px; width: 80%;">
                        <a href="${depositData.qr_image}" download="QRIS_${data.reff_id}.png" class="btn-primary animate__animated animate__pulse">
                            <i class="fas fa-download"></i> Download QR Code
                        </a>
                    `;
                } else if (depositData.url_pembayaran) {
                    paymentActionEl.innerHTML = `
                        <a href="${depositData.url_pembayaran}" target="_blank" class="btn-primary animate__animated animate__pulse">
                            <i class="fas fa-wallet"></i> Bayar Sekarang
                        </a>
                    `;
                } else {
                    paymentActionEl.innerHTML = `
                        <p class="text-text-medium text-lg animate__animated animate__fadeIn">Tidak ada metode pembayaran yang tersedia untuk transaksi ini.</p>
                    `;
                }
            } else {
                paymentActionEl.innerHTML = `
                    <p class="text-text-medium text-lg animate__animated animate__fadeIn">Transaksi telah ${transactionStatus === 'completed' ? 'berhasil' : transactionStatus === 'paid' ? 'dibayar' : transactionStatus}.</p>
                `;
            }
        }

        // Fungsi untuk mengupdate countdown timer
        function updateCountdown(expiredAt) {
            if (countdownInterval) {
                clearInterval(countdownInterval); // Clear any existing interval
            }

            const expiredTime = new Date(expiredAt).getTime();
            
            countdownEl.classList.remove('hidden');
            countdownEl.classList.add('animate__animated', 'animate__fadeIn');

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = expiredTime - now;

                if (diff < 0) {
                    clearInterval(countdownInterval);
                    countdownEl.textContent = "Waktu pembayaran telah habis.";
                    countdownEl.classList.remove('animate__pulse', 'bg-danger-color/15', 'border-danger-color/40');
                    countdownEl.classList.add('bg-gray-700/20', 'text-text-medium', 'border-gray-600/40');
                    // Optionally, reload transaction to show expired status from API
                    loadTransaction(); 
                } else {
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    countdownEl.textContent = `Sisa waktu: ${minutes}m ${seconds}s`;
                }
            }, 1000);
        }

        // Fungsi utama untuk memuat data transaksi
        async function loadTransaction() {
            loadingOverlayEl.classList.remove("hidden"); // Show global loading overlay
            
            try {
                const res = await fetch(`https://danzkugamestore.vercel.app/api/transaction/${reff_id}`);
                const json = await res.json();
                
                if (json.status !== "success") {
                    displayError(json.message || "Transaksi tidak ditemukan.");
                    return;
                }

                const data = json.data;
                updateTransactionDetails(data);

                // Start countdown only if transaction is pending and not expired
                const now = new Date().getTime();
                const expiredTime = data.data_deposit.expired_at ? new Date(data.data_deposit.expired_at).getTime() : 0;

                if ((data.status === 'pending' || data.status === 'unpaid') && expiredTime > now) {
                    updateCountdown(data.data_deposit.expired_at);
                    // Automatically refresh transaction status every 10 seconds if pending/unpaid
                    setTimeout(loadTransaction, 10000); 
                } else {
                    clearInterval(countdownInterval); // Stop countdown if status is not pending/unpaid or already expired
                    countdownEl.classList.add('hidden');
                }

            } catch (err) {
                console.error("Error loading transaction:", err);
                displayError("Gagal memuat data transaksi. Terjadi kesalahan jaringan.");
            } finally {
                loadingOverlayEl.classList.add("hidden"); // Hide global loading overlay
            }
        }

        // Inisialisasi: Periksa reff_id dan muat transaksi
        if (!reff_id) {
            loadingOverlayEl.classList.add("hidden"); // Hide loading if no reff_id
            displayError("Reff ID tidak ditemukan di URL. Pastikan Anda mengakses tautan yang benar.");
        } else {
            loadTransaction();
        }
    </script>
</body>
</html>